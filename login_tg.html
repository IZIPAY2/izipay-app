<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IZIPAY | Authentication</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root { --bg-dark: #0f1115; --card-bg: #ffffff; --primary-green: #638576; --text-dark: #1a1a1a; --text-gray: #8e8e93; --border-light: #e5e7eb; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: white; min-height: 100vh; display: flex; flex-direction: column; padding: 20px; }
        
        .mobile-header { padding: 20px 0; margin-bottom: 20px; }
        .header-title h1 { font-size: 26px; font-weight: 600; margin-bottom: 5px; }
        .header-title p { font-size: 14px; color: rgba(255,255,255,0.6); }

        .auth-card { background: var(--card-bg); border-radius: 24px; padding: 28px; color: var(--text-dark); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .toggle-container { background: #f3f4f6; border-radius: 100px; padding: 4px; display: flex; margin-bottom: 25px; }
        .toggle-btn { flex: 1; padding: 10px; border: none; background: transparent; font-size: 14px; font-weight: 600; color: var(--text-gray); border-radius: 100px; cursor: pointer; transition: 0.2s; }
        .toggle-btn.active { background: white; color: var(--text-dark); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .form-group { margin-bottom: 15px; }
        .input-wrapper { display: flex; align-items: center; border: 1px solid var(--border-light); border-radius: 14px; padding: 0 15px; height: 58px; transition: 0.2s; }
        .input-wrapper:focus-within { border-color: var(--primary-green); }
        .input-icon { font-size: 18px; color: var(--text-gray); margin-right: 12px; }
        .input-content { flex: 1; display: flex; flex-direction: column; }
        .input-label { font-size: 10px; color: var(--text-gray); font-weight: 600; text-transform: uppercase; }
        .custom-input { border: none; outline: none; font-size: 15px; font-weight: 500; width: 100%; background: transparent; }

        .btn-primary { width: 100%; height: 54px; background: var(--primary-green); color: white; border: none; border-radius: 100px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 15px rgba(99, 133, 118, 0.3); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: 0.3s; z-index: 1000; font-size: 14px; font-weight: 500; text-align: center; width: 80%; max-width: 300px; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.error { color: #ef4444; border-bottom: 3px solid #ef4444; }
        .toast.success { color: #10b981; border-bottom: 3px solid #10b981; }
    </style>
</head>
<body>

    <div class="mobile-header">
        <div class="header-title">
            <h1 id="titleText">Welcome Back</h1>
            <p id="subTitleText">Link your Telegram to manage IZIPAY</p>
        </div>
    </div>

    <div class="auth-card">
        <div class="toggle-container">
            <button class="toggle-btn active" id="loginTab" onclick="switchMode('login')">Login</button>
            <button class="toggle-btn" id="registerTab" onclick="switchMode('register')">Register</button>
        </div>

        <form id="authForm">
            <div class="form-group">
                <div class="input-wrapper">
                    <i class="ri-mail-line input-icon"></i>
                    <div class="input-content">
                        <label class="input-label">Email Address</label>
                        <input type="email" id="email" class="custom-input" placeholder="name@example.com" required>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="input-wrapper">
                    <i class="ri-lock-line input-icon"></i>
                    <div class="input-content">
                        <label class="input-label">Password</label>
                        <input type="password" id="password" class="custom-input" placeholder="••••••••" required>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-primary" id="submitBtn">Link Account</button>
        </form>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        let currentMode = 'login';

        function switchMode(mode) {
            currentMode = mode;
            const loginBtn = document.getElementById('loginTab');
            const registerBtn = document.getElementById('registerTab');
            
            if (mode === 'login') {
                loginBtn.classList.add('active');
                registerBtn.classList.remove('active');
                document.getElementById('titleText').innerText = 'Welcome Back';
                document.getElementById('subTitleText').innerText = 'Link your existing account';
                document.getElementById('submitBtn').innerText = 'Link Account';
            } else {
                registerBtn.classList.add('active');
                loginBtn.classList.remove('active');
                document.getElementById('titleText').innerText = 'Create Account';
                document.getElementById('subTitleText').innerText = 'New to IZIPAY? Register now';
                document.getElementById('submitBtn').innerText = 'Register & Link';
            }
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        document.getElementById("authForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            
            btn.disabled = true;
            btn.innerText = "Processing...";

            const payload = {
                action: currentMode,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                tg_id: tg.initDataUnsafe?.user?.id || "7897252945"
            };

            try {
                const response = await fetch('https://izipay.me/api/auth_tg.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showToast(result.message, "success");
                    setTimeout(() => { 
                        // Анти-кэш редирект на главную
                        window.location.replace('index.html?v=' + Date.now()); 
                    }, 1500);
                } else {
                    showToast(result.message, "error");
                    btn.disabled = false;
                    btn.innerText = currentMode === 'login' ? 'Link Account' : 'Register & Link';
                }
            } catch (error) {
                showToast("Connection Error", "error");
                btn.disabled = false;
                btn.innerText = currentMode === 'login' ? 'Link Account' : 'Register & Link';
            }
        });
    </script>
</body>
</html>
