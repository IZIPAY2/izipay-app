<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Withdraw | IZIPAY</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f1115; --card-bg: #ffffff; --primary-green: #638576; 
            --text-dark: #1a1a1a; --text-gray: #8e8e93; --border-light: #e5e7eb;
            --toggle-bg: #f3f4f6; --error-red: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .mobile-header { padding: 24px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .back-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: white; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; text-decoration: none; }
        .content-sheet { background: var(--card-bg); flex-grow: 1; border-top-left-radius: 32px; border-top-right-radius: 32px; padding: 32px 24px; color: var(--text-dark); animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); overflow-y: auto; height: 100%; }
        .card-selector-box { margin-bottom: 24px; }
        .card-selector-box label { display: block; font-size: 13px; font-weight: 600; color: var(--text-gray); margin-bottom: 10px; text-transform: uppercase; }
        .styled-select { width: 100%; padding: 16px; border-radius: 14px; border: 1px solid var(--border-light); background: var(--toggle-bg); font-size: 15px; font-weight: 600; color: var(--text-dark); outline: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23638576'%3E%3Cpath d='M12 16L6 10H18L12 16Z'%3E%3C/path%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; background-size: 24px; }
        .form-group { margin-bottom: 16px; }
        .input-wrapper { display: flex; align-items: center; border: 1px solid var(--border-light); border-radius: 16px; padding: 4px 16px; height: 64px; background: var(--toggle-bg); }
        .input-icon { font-size: 20px; color: var(--text-gray); margin-right: 12px; }
        .input-content { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .input-label { font-size: 11px; color: var(--text-gray); margin-bottom: 2px; }
        .custom-input { border: none; outline: none; font-size: 15px; font-weight: 500; color: var(--text-dark); width: 100%; background: transparent; }
        .max-btn { font-size: 12px; font-weight: 600; color: var(--primary-green); background: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; border: 1px solid var(--border-light); }
        .btn-primary { width: 100%; height: 56px; background: var(--primary-green); color: white; border: none; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<div class="mobile-header">
    <a href="index.html" class="back-btn"><i class="ri-arrow-left-line"></i></a>
    <div style="font-weight: 600;">Withdraw Funds</div>
    <div style="width:40px;"></div>
</div>

<div class="content-sheet">
    <form id="withdrawForm">
        <div class="card-selector-box">
            <label>Withdraw from Card</label>
            <select id="cardSelect" class="styled-select" required></select>
        </div>

        <div class="form-group">
            <div class="input-wrapper">
                <i class="ri-coin-line input-icon"></i>
                <div class="input-content">
                    <label class="input-label">Cryptocurrency</label>
                    <select id="cryptoSelect" class="custom-input" required onchange="updateNetworks()">
                        <option value="" disabled selected>Select Coin</option>
                        <option value="USDT">Tether (USDT)</option>
                        <option value="BTC">Bitcoin (BTC)</option>
                        <option value="ETH">Ethereum (ETH)</option>
                        <option value="USDC">USD Coin (USDC)</option>
                        <option value="SOL">Solana (SOL)</option>
                        <option value="TRX">Tron (TRX)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="form-group">
            <div class="input-wrapper">
                <i class="ri-global-line input-icon"></i>
                <div class="input-content">
                    <label class="input-label">Network</label>
                    <select id="networkSelect" class="custom-input" required>
                        <option value="" disabled selected>Select Coin first</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="form-group">
            <div class="input-wrapper">
                <i class="ri-wallet-3-line input-icon"></i>
                <div class="input-content">
                    <label class="input-label">Wallet Address</label>
                    <input type="text" id="wallet_addr" class="custom-input" placeholder="Paste address here" required>
                </div>
            </div>
        </div>

        <div class="form-group">
            <div class="input-wrapper">
                <i class="ri-money-dollar-circle-line input-icon"></i>
                <div class="input-content">
                    <label class="input-label">Amount (USD)</label>
                    <input type="number" id="withdraw_amount" class="custom-input" placeholder="0.00" min="1" step="0.01" required>
                </div>
                <button type="button" class="max-btn" onclick="setMax()">MAX</button>
            </div>
        </div>

        <button type="submit" class="btn-primary" id="submitBtn">
            <span id="btnText">Confirm Withdrawal</span>
        </button>
    </form>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const userId = tg.initDataUnsafe?.user?.id || "7897252945";
    tg.expand();

    const networks = {
        'USDT': ['TRC20', 'ERC20', 'BEP20', 'SOL'],
        'BTC': ['Bitcoin'],
        'ETH': ['ERC20'],
        'USDC': ['ERC20', 'TRC20', 'SOL'],
        'SOL': ['Solana'],
        'TRX': ['TRC20']
    };

    async function loadCards() {
        const response = await fetch(`https://izipay.me/api/get_dashboard.php?tg_id=${userId}`);
        const data = await response.json();
        const select = document.getElementById('cardSelect');
        if (data.status === 'success') {
            data.cards.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.card_number;
                opt.dataset.balance = c.balance;
                opt.textContent = `${c.card_number.slice(0,4)}...${c.card_number.slice(-4)} ($${c.balance})`;
                select.appendChild(opt);
            });
        }
    }

    function updateNetworks() {
        const coin = document.getElementById('cryptoSelect').value;
        const netSelect = document.getElementById('networkSelect');
        netSelect.innerHTML = '';
        networks[coin].forEach(n => {
            const opt = document.createElement('option');
            opt.value = n; opt.textContent = n;
            netSelect.appendChild(opt);
        });
    }

    function setMax() {
        const select = document.getElementById('cardSelect');
        const balance = select.options[select.selectedIndex].dataset.balance;
        document.getElementById('withdraw_amount').value = balance;
    }

    document.getElementById('withdrawForm').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        document.getElementById('btnText').innerHTML = '<div class="spinner"></div>';

        const payload = {
            tg_id: userId,
            amount: document.getElementById('withdraw_amount').value,
            card_number: document.getElementById('cardSelect').value,
            wallet: document.getElementById('wallet_addr').value,
            crypto: document.getElementById('cryptoSelect').value,
            network: document.getElementById('networkSelect').value
        };

        const response = await fetch('https://izipay.me/api/withdraw_tg.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await response.json();

        if (result.status === 'success') {
            tg.showAlert("Withdrawal request sent! Processing time: ~15 min.");
            window.location.href = 'index.html';
        } else {
            tg.showAlert("Error: " + result.message);
            btn.disabled = false;
            document.getElementById('btnText').innerText = 'Confirm Withdrawal';
        }
    };

    loadCards();
</script>
</body>
</html>
